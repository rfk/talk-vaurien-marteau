<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=1024, user-scalable=no">

  <title>Testing for Graceful Failure with Vaurien and Marteau</title>

  <link rel="stylesheet" href="./resources/deck-js/core/deck.core.css">
  <link rel="stylesheet" href="./resources/deck-js/extensions/hash/deck.hash.css">
  <link rel="stylesheet" href="./resources/deck-js/themes/style/rfkelly.css">

  <link rel="stylesheet" href="./resources/playitagainsam-js/playitagainsam.css">

  <style type="text/css">
  body .pias-container {
    margin: 1em;
  }
  .deck-container table {
    border-collapse: collapse;
  }
  .deck-container table td {
    padding: 0.5em;
  }
  .deck-container .slide iframe {
    max-width: none;
    margin-bottom: 10px;
  }
  .deck-container div.run-timer {
    position: absolute;
    bottom: 0px;
    left: 0px;
    background: black;
    height: 5px;
    width: 20px;
  }
  .deck-container div.run-timer-toofast {
    background: blue;
  }
  .deck-container div.run-timer-ontrack {
    background: green;
  }
  .deck-container div.run-timer-tooslow {
    background: red;
  }
  .deck-container {
    color: #222222;
  }
  </style>

  <script src="./resources/deck-js/modernizr.custom.js"></script>
  <script src="./resources/deck-js/jquery-1.7.2.min.js"></script>
  <script src="./resources/deck-js/core/deck.core.js"></script>
  <script src="./resources/deck-js/extensions/hash/deck.hash.js"></script>
  <script src="./resources/playitagainsam-js/playitagainsam.js"></script>

  <script type="text/javascript">
  $(function() {
      $.deck('.slide');
  });

  var onEnterSlideCallbacks = {}
  var onEnterSlide = function(selector, cb) {
      var slide_id = $(selector).attr("id");
      if(typeof onEnterSlideCallbacks[slide_id] == "undefined") {
          onEnterSlideCallbacks[slide_id] = [];
      }
      onEnterSlideCallbacks[slide_id].push(cb)
  }
  $(document).bind("deck.change", function(event, from, to) {
      var $slide = $.deck("getSlide", to);
      var slide_id = $slide.attr("id");
      if(showStartTime == null && slide_id != "title") {
          $slide.find(".run-timer").each(function() {
              showStartTime = Math.round((new Date()).getTime() / 1000);
              var times = $(this).attr("id").split("-").slice(1,3);
              showStartTime -= parseInt(times[0], 10);
              updateShowTimers();
          });
      }
      var callbacks = onEnterSlideCallbacks[slide_id];
      if(typeof callbacks != "undefined") {
          for(var i=0; i<callbacks.length; i++) {
              callbacks[i]();
          }
      }
  });

  var showStartTime = null;
  var updateShowTimers = function() {
      if(showStartTime != null) {
          var now = Math.round((new Date()).getTime() / 1000);
          var runtime = now - showStartTime
          $(".run-timer").each(function() {
              var $this = $(this);
              var times = $this.attr("id").split("-").slice(1,3);
              if(runtime < parseInt(times[0], 10)) {
                  $this.removeClass("run-timer-tooslow");
                  $this.removeClass("run-timer-ontrack");
                  $this.addClass("run-timer-toofast");
              } else if(runtime > parseInt(times[1], 10)) {
                  $this.removeClass("run-timer-toofast");
                  $this.removeClass("run-timer-ontrack");
                  $this.addClass("run-timer-tooslow");
              } else {
                  $this.removeClass("run-timer-toofast");
                  $this.removeClass("run-timer-tooslow");
                  $this.addClass("run-timer-ontrack");
              }
          });
      }
      setTimeout(updateShowTimers, 5 * 1000);
  }
  </script>

</head>
<body class="deck-container">


<section class="slide" id="title">
  <h2>Testing for Graceful Failure with</h2>
  <h1>Vaurien &amp; Marteau</h1>
</section>


<section class="slide">
  <h1>Testing!</h1>
</section>


<section class="slide">
  <h2>Starting Point</h2>
  <ul>
   <li>You have a web application</li>
   <li>You have a proper deployment setup</li>
   <li>You are confident that it <i>works</i></li>
   <li class="slide">Now...what happens when it starts to break?</li>
  </ul>
</section>


<section class="slide">
 <h2>What do I know anyway?</h2>
 <ul>
   <li>Mozilla Services</li>
   <ul><li>Firefox Sync Server</li></ul>
   <ul><li>Firefox Marketplace</li></ul>
   <ul><li>A bunch more in the pipe</li></ul>
   </ul>
 </ul>
</section>


<section class="slide">
  <h2>A Real-Life Bug</h2>
  <img src="./resources/Diagram1.svg" >
</section>


<section class="slide">
  <h1>How do you<br/>find these bugs?</h1>
</section>


<section class="slide">
  <h1>Do it Live!</h1>
  <img src="./resources/do-it-live.jpg" />
</section>


<section class="slide">
  <h2>Doing it live:</h2>
  <ol>
    <li>Deploy it</li>
    <li>Stress it</li>
    <li>Break it</li>
  </ol>
</section>


<section class="slide">
  <h2>Doing it live:</h2>
  <ol>
    <li>Deploy it</li>
    <li>Stress it</li>
    <li>Break it</li>
    <li>???</li>
  </ol>
</section>


<section class="slide">
  <h2>Doing it live:</h2>
  <ol>
    <li>Deploy it</li>
    <li>Stress it</li>
    <li>Break it</li>
    <li>???</li>
    <li>Profit</li>
  </ol>
</section>


<section class="slide">
  <h1>1) Deploy it</h1>
</section>


<section class="slide" id="pias-deployit-slide">
  <div id="pias-deployit-player"></div>
  <script type="text/javascript" src="./resources/pias-deployit.js"></script>
  <script type="text/javascript">
      $(function() {
          onEnterSlide("#pias-deployit-slide", function() {
              var player = new PIAS.Player($("#pias-deployit-player"))
              player.play(window.pias_deployit_data, function() {
                  player.destroy();
              });
          });
      });
    </script>
</section>


<section class="slide">
  <h1>2) Stress it</h1>
</section>


<section class="slide">
  <h1>Marteau</h1>
</section>


<section class="slide">
  <h2>Marteau is:</h2>
  <ul>
    <li>A front-end for FunkLoad:</li>
    <ul><li>Create worker nodes in AWS</li>
        <li>Manage job queue</li>
        <li>Generate and save reports</li>
    </ul>
    <li>French for "hammer"</li>
  </ul>
</section>


<section class="slide">
  <h1>FunkLoad</h1>
</section>


<section class="slide">
  <h2>FunkLoad</h2>
  <p>XXX TODO interactive demo of writing the tests, running them from the console</p>
</section>


<section class="slide">
  <h1>Marteau</h1>
</section>


<section class="slide">
  <h2>Marteau</h2>
  <p><a href="./resources/marteau-snapshot/index.html" target="_blank">(opens in new tab)</a></p>
</section>


<section class="slide">
  <h2>Marteau</h2>
  <p>XXX TODO interactive demo of setting the .marteau.yml file, submitting from the command-line</p>
</section>


<section class="slide">
  <h1>3) Break it</h1>
</section>


<section class="slide">
  <h1>Vaurien</h1>
</section>


<section class="slide">
  <h2>Vaurien is:</h2>
  <ul>
    <li>A misbehaving TCP proxy:</li>
    <ul><li>Delays responses, drops connections, returns garbage</li>
        <li>Speaks several common protocols (badly)</li>
        <li>Easily extensible for your needs</li>
    </ul>
    <li>French for "rapscallion"</li>
  </ul>
</section>


<section class="slide">
  <p>Run a vaurien proxy, then interact with the webservice as before</p>
  <p>Tear it down, set up some failing behaviour, show it failing</p>
  <p>Show that we can control it via HTTP API</p>
</section>


<section class="slide">
  <p>Example of using it in a unittest, via in-process control</p>
</section>


<section class="slide">
  <p>Combine the two approaches: give 5% errors on your database, see if only 5% of your requests give an error</p>
</section>


<section class="slide">
  <h1>one more thing...</h1>
</section>


<section class="slide">
  <h1>FunkLoad</h1>
</section>


<section class="slide">
  <h1 style="text-decoration: line-through">FunkLoad</h1>
</section>


<section class="slide">
  <h1>loads</h1>
</section>


<section class="slide">
  <h2>loads is:</h2>
  <ul><li>A better FunkLoad:</li>
      <ul><li>Easier to write tests</li>
          <li>Much more concurrency per node</li>
          <li>More real-time feedback, stats, etc</li>
      </ul>
      <li>Not ready yet, but stay tuned!</li>
      <li>Not French for anything AFAICT...</li>
  </ul>
</section>


<section class="slide">
<h1>Summing Up</h1>
</section>


<section class="slide">
<h2>Take Home Messages:</h2>
<ul><li>How does your app interact with the outside world?</li>
    <li>What happens when the outside world misbehaves?</li>
    <li>How can you simulate that under controlled conditions?</li>
    <li class="slide">Come hack with us!</li>
</ul>
</section>


<section class="slide">
  <h1>Thanks</h1>
</section>


<section class="slide">
  <h2>Thanks</h2>
  <ul>
   <li>Tarek Ziade</li>
   <li>Alexis Metaireau</li>
   <li>James Bonacci</li>
  </ul>
</section>


<section class="slide">
  <h2>More Info</h2>
  <div style="text-align: center">
  <p>ryan@rfk.id.au</p>
  <br /><br />
  <p>https://github.com/rfk/talk-vaurien-marteau</p>
  <br /><br />
  <p>http://funkload.nuxeo.org/</p>
  <p>http://marteau.readthedocs.org</p>
  <p>http://vaurien.readthedocs.org</p>
  <p>http://loads.readthedocs.org</p>
  </div>
</section>

</body>
</html>
